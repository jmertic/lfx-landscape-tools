name: Update Landscape from LFX
description: Update the given landscape from LFx
inputs:
  project_processing:
    description: "Indicate for project processing, if they should be 'rebuild' or 'sync' ( or 'skip' to not build projects )"
    default: "sync"
  configfile:
    description: "Filename for the config file ( defaults to config.yml )"
    default: "config.yml"
  logfile:
    description: "Filename for the log file ( defaults to debug.log )"
    default: "debug.log"
runs:
  using: composite
  steps:
    - name: Install cairo
      uses: awalsh128/cache-apt-pkgs-action@acb598e5ddbc6f68a970c5da0688d2f3a9f04d05 # v1.6.0
      with:
        packages: libcairo2-dev pkg-config python3-dev
        version: 1.0
    - name: Checkout landscape
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.1.7@v4
      with:
        token: ${{ env.token }}
        repository: ${{ env.repository }}
        ref: ${{ env.ref }}
        path: landscape
    - name: Checkout landscape-tools
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.1.7@v4
      with:
        token: ${{ env.token }}
        repository: jmertic/lfx-landscape-tools
        path: landscape-tools
    - name: Set up Python 3.x
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: '3.x'
    - name: Install poetry
      uses: abatilo/actions-poetry@3765cf608f2d4a72178a9fc5b918668e542b89b1 # v4.0.0
    - name: Install dependencies
      shell: bash
      working-directory: ./landscape-tools
      run: poetry install
    - name: Build members from LFX
      working-directory: ./landscape-tools
      shell: bash
      run: poetry run lfx_landscape -s -l debug --logfile $LOGFILE build_members  -c ../landscape/$CONFIGFILE
      env:
        GITHUB_TOKEN: ${{ env.token }}
        GH_TOKEN: ${{ env.token }}
        CONFIGFILE: ${{ inputs.configfile }}
        LOGFILE: ${{ inputs.logfile }}
    - name: Rebuild projects from LFX and other sources
      if: ${{ inputs.project_processing == 'rebuild' }}
      working-directory: ./landscape-tools
      shell: bash
      run: poetry run lfx_landscape -s -l debug --logfile $LOGFILE build_projects -c ../landscape/$CONFIGFILE
      env:
        GITHUB_TOKEN: ${{ env.token }}
        GH_TOKEN: ${{ env.token }}
        CONFIGFILE: ${{ inputs.configfile }}
        LOGFILE: ${{ inputs.logfile }}
    - name: Sync projects from LFX and other sources
      if: ${{ inputs.project_processing == 'sync' }}
      working-directory: ./landscape-tools
      shell: bash
      run: poetry run lfx_landscape -s -l debug --logfile $LOGFILE sync_projects -c ../landscape/$CONFIGFILE
      env:
        GITHUB_TOKEN: ${{ env.token }}
        GH_TOKEN: ${{ env.token }}
        CONFIGFILE: ${{ inputs.configfile }}
        LOGFILE: ${{ inputs.logfile }}
    - name: Save logfiles file
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: ${{ inputs.logfile }} 
        path: ./landscape-tools/${{ inputs.logfile }}
        if-no-files-found: ignore
    - name: Validate landscape2 data
      uses: cncf/landscape2-validate-action@6381e8747c73412e638670807b402ef2b863e9f8 # v2.0.1
      with:
        target_kind: data
        target_path: ./landscape/landscape.yml
    - name: Get current date
      id: date
      uses: Kaven-Universe/github-action-current-date-time@f2c12d90cff9c3e7b1f50430886e632fe31fcee1 # v1.4.0
      with:
        format: "YYYY-MM-DD"
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7.0.11
      with:
        token: ${{ env.token }}
        branch-suffix: timestamp
        path: ./landscape
        title: "Update Landscape from LFX ${{ steps.date.outputs.time }}"
        labels: automated-build
        commit-message: Update Landscape from LFX
        signoff: true

